<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc =
  "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

const upload = document.getElementById("upload");
const pdfContainer = document.getElementById("pdf-container");
const status = document.getElementById("status");
const addTextBtn = document.getElementById("addTextBtn");

let pdfDoc = null;
let overlays = [];

upload.onchange = async function (e) {
  const file = e.target.files[0];
  if (!file) return;

  status.innerText = "Loading PDF...";
  pdfContainer.innerHTML = "";
  overlays = [];

  const reader = new FileReader();
  reader.readAsArrayBuffer(file);

  reader.onload = async function () {
    const typedarray = new Uint8Array(this.result);
    pdfDoc = await pdfjsLib.getDocument(typedarray).promise;

    status.innerText = `PDF loaded (${pdfDoc.numPages} pages)`;

    for (let pageNum = 1; pageNum <= pdfDoc.numPages; pageNum++) {
      await renderPage(pageNum);
    }
  };
};

async function renderPage(pageNum) {
  const page = await pdfDoc.getPage(pageNum);
  const scale = 1.3;
  const viewport = page.getViewport({ scale });

  const wrapper = document.createElement("div");
  wrapper.style.position = "relative";
  wrapper.style.margin = "20px auto";
  wrapper.style.background = "white";
  wrapper.style.boxShadow = "0 10px 25px rgba(0,0,0,0.08)";

  const canvas = document.createElement("canvas");
  const ctx = canvas.getContext("2d");
  canvas.width = viewport.width;
  canvas.height = viewport.height;

  wrapper.appendChild(canvas);
  pdfContainer.appendChild(wrapper);

  await page.render({ canvasContext: ctx, viewport }).promise;

  const overlay = document.createElement("div");
  overlay.style.position = "absolute";
  overlay.style.top = "0";
  overlay.style.left = "0";
  overlay.style.width = canvas.width + "px";
  overlay.style.height = canvas.height + "px";

  wrapper.appendChild(overlay);
  overlays.push(overlay);
}

addTextBtn.onclick = function () {
  if (!overlays.length) {
    alert("Upload a PDF first");
    return;
  }

  const textBox = document.createElement("div");
  textBox.contentEditable = true;
  textBox.innerText = "Edit text";
  textBox.style.position = "absolute";
  textBox.style.top = "100px";
  textBox.style.left = "100px";
  textBox.style.fontSize = "22px";
  textBox.style.fontFamily = "Times New Roman";
  textBox.style.color = "black";
  textBox.style.border = "1px dashed #2563eb";
  textBox.style.padding = "4px";
  textBox.style.cursor = "move";
  textBox.style.background = "transparent";

  enableDrag(textBox);
  overlays[0].appendChild(textBox);
};

function enableDrag(el) {
  let isDown = false;
  let offsetX = 0;
  let offsetY = 0;

  el.onmousedown = (e) => {
    isDown = true;
    offsetX = e.offsetX;
    offsetY = e.offsetY;
  };

  document.onmousemove = (e) => {
    if (!isDown) return;
    el.style.left = e.pageX - offsetX + "px";
    el.style.top = e.pageY - offsetY + "px";
  };

  document.onmouseup = () => {
    isDown = false;
  };
}
</script>


