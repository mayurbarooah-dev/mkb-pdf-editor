<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>MKB PDF Editor</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>

<style>
body {
  margin: 0;
  font-family: Inter, system-ui;
  background: #0a0f1e;
  color: #e5e7eb;
}
header {
  padding: 14px 22px;
  background: #020617;
  border-bottom: 1px solid #1f2933;
}
.toolbar {
  padding: 12px 22px;
  display: flex;
  gap: 10px;
  background: #020617;
}
button, input {
  background: #111827;
  color: white;
  border: 1px solid #374151;
  border-radius: 8px;
  padding: 8px 14px;
}
button.primary {
  background: #2563eb;
  border: none;
}
#viewer {
  display: flex;
}
#pages {
  padding: 20px;
  flex: 1;
}
.page {
  position: relative;
  background: white;
  margin-bottom: 24px;
  box-shadow: 0 10px 30px rgba(0,0,0,.4);
}
.text-box {
  position: absolute;
  cursor: text;
}
.text-box:hover {
  outline: 1px dashed #2563eb;
}
.editor {
  position: absolute;
  border: 1px solid #2563eb;
  resize: both;
  overflow: hidden;
  background: rgba(255,255,255,.98);
}
</style>
</head>

<body>

<header><b>MKB PDF Editor</b></header>

<div class="toolbar">
  <input type="file" id="file" accept="application/pdf">
  <button class="primary" id="download">Download PDF</button>
</div>

<div id="viewer">
  <div id="pages"></div>
</div>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc =
  'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

let pdfDoc, edits = [];

document.getElementById('file').onchange = async e => {
  const buf = await e.target.files[0].arrayBuffer();
  pdfDoc = await pdfjsLib.getDocument({ data: buf }).promise;
  pages.innerHTML = '';
  edits = [];
  for (let i = 1; i <= pdfDoc.numPages; i++) renderPage(i);
};

async function renderPage(n) {
  const page = await pdfDoc.getPage(n);
  const scale = 1.5;
  const vp = page.getViewport({ scale });

  const div = document.createElement('div');
  div.className = 'page';
  div.style.width = vp.width + 'px';
  div.style.height = vp.height + 'px';

  const canvas = document.createElement('canvas');
  canvas.width = vp.width;
  canvas.height = vp.height;
  await page.render({ canvasContext: canvas.getContext('2d'), viewport: vp }).promise;
  div.appendChild(canvas);

  const layer = document.createElement('div');
  layer.style.position = 'absolute';
  layer.style.inset = 0;
  div.appendChild(layer);

  const tc = await page.getTextContent();
  tc.items.forEach(t => {
    const size = Math.sqrt(t.transform[0] ** 2 + t.transform[1] ** 2) * scale;
    const el = document.createElement('div');
    el.className = 'text-box';
    el.textContent = t.str;
    el.style.left = t.transform[4] * scale + 'px';
    el.style.top = (vp.height - t.transform[5] * scale - size) + 'px';
    el.style.fontSize = size + 'px';
    el.style.width = t.width * scale + 'px';
    el.style.height = size + 'px';

    el.ondblclick = () => edit(el, n);
    layer.appendChild(el);
  });

  pages.appendChild(div);
}

function edit(el, page) {
  const ed = document.createElement('textarea');
  ed.className = 'editor';
  ed.value = el.textContent;
  ed.style.cssText = el.style.cssText;
  el.parentNode.appendChild(ed);
  el.style.visibility = 'hidden';
  ed.focus();

  let dragging = false, ox, oy;
  ed.onmousedown = e => {
    dragging = true;
    ox = e.offsetX; oy = e.offsetY;
  };
  window.onmousemove = e => {
    if (!dragging) return;
    ed.style.left = e.pageX - ox + 'px';
    ed.style.top = e.pageY - oy + 'px';
  };
  window.onmouseup = () => dragging = false;

  ed.onblur = () => {
    edits.push({
      page,
      text: ed.value,
      x: parseFloat(ed.style.left),
      y: parseFloat(ed.style.top),
      size: parseFloat(ed.style.fontSize),
      w: parseFloat(ed.style.width),
      h: parseFloat(ed.style.height)
    });
    ed.remove();
  };
}

download.onclick = async () => {
  const file = document.getElementById('file').files[0];
  const pdf = await PDFLib.PDFDocument.load(await file.arrayBuffer());

  edits.forEach(e => {
    const p = pdf.getPages()[e.page - 1];
    const h = p.getSize().height;

    p.drawRectangle({
      x: e.x,
      y: h - e.y - e.h,
      width: e.w,
      height: e.h,
      color: PDFLib.rgb(1,1,1)
    });

    p.drawText(e.text, {
      x: e.x,
      y: h - e.y - e.h + 2,
      size: e.size,
      color: PDFLib.rgb(0,0,0)
    });
  });

  const out = await pdf.save();
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([out]));
  a.download = 'edited.pdf';
  a.click();
};
</script>

</body>
</html>
