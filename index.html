<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MKB PDF Editor â€“ Find & Replace</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>

<style>
body {
  margin: 0;
  font-family: Inter, system-ui, sans-serif;
  background: #0b1020;
  color: #e5e7eb;
}

header {
  padding: 12px 16px;
  display: flex;
  gap: 8px;
  align-items: center;
  background: #020617;
  border-bottom: 1px solid #1f2937;
}

input, button {
  padding: 8px 10px;
  border-radius: 6px;
  border: 1px solid #1f2937;
  background: #020617;
  color: white;
}

button.primary {
  background: #2563eb;
  border: none;
}

#pages {
  padding: 20px;
}

.page {
  position: relative;
  background: white;
  margin-bottom: 24px;
  box-shadow: 0 10px 30px rgba(0,0,0,.4);
}

.textLayer span {
  cursor: pointer;
}

.highlight {
  background: rgba(255,200,0,0.5);
}

.editor {
  position: absolute;
  z-index: 9999;
  border: 2px solid #2563eb;
  background: white;
  padding: 4px;
}
</style>
</head>

<body>

<header>
  <input type="file" id="file">
  <input type="text" id="findText" placeholder="Find">
  <input type="text" id="replaceText" placeholder="Replace with">
  <button id="findBtn">Find</button>
  <button id="replaceBtn">Replace All</button>
  <button class="primary" id="download">Download</button>
</header>

<div id="pages"></div>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc =
  "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

let pdfDoc;
let matches = [];
let edits = [];

file.onchange = async e => {
  const buf = await e.target.files[0].arrayBuffer();
  pdfDoc = await pdfjsLib.getDocument({data: buf}).promise;
  pages.innerHTML = "";
  matches = [];
  edits = [];
  for (let i = 1; i <= pdfDoc.numPages; i++) renderPage(i);
};

async function renderPage(num) {
  const page = await pdfDoc.getPage(num);
  const scale = 1.5;
  const vp = page.getViewport({ scale });

  const pageDiv = document.createElement("div");
  pageDiv.className = "page";
  pageDiv.style.width = vp.width + "px";
  pageDiv.style.height = vp.height + "px";

  const canvas = document.createElement("canvas");
  canvas.width = vp.width;
  canvas.height = vp.height;
  await page.render({ canvasContext: canvas.getContext("2d"), viewport: vp }).promise;
  pageDiv.appendChild(canvas);

  const textLayer = document.createElement("div");
  textLayer.style.position = "absolute";
  textLayer.style.inset = 0;
  pageDiv.appendChild(textLayer);

  const tc = await page.getTextContent();
  tc.items.forEach(t => {
    if (!t.str.trim()) return;
    const size = Math.sqrt(t.transform[0]**2 + t.transform[1]**2) * scale;
    const span = document.createElement("span");
    span.textContent = t.str;
    span.style.position = "absolute";
    span.style.left = t.transform[4] * scale + "px";
    span.style.top = (vp.height - t.transform[5] * scale - size) + "px";
    span.style.fontSize = size + "px";
    span.dataset.page = num;
    textLayer.appendChild(span);
  });

  pages.appendChild(pageDiv);
}

/* FIND */
findBtn.onclick = () => {
  clearHighlights();
  matches = [];
  const q = findText.value;
  if (!q) return;

  document.querySelectorAll(".textLayer span").forEach(span => {
    if (span.textContent.includes(q)) {
      span.classList.add("highlight");
      matches.push(span);
    }
  });
};

/* REPLACE ALL */
replaceBtn.onclick = () => {
  const q = findText.value;
  const r = replaceText.value;
  if (!q) return;

  matches.forEach(span => {
    const rect = span.getBoundingClientRect();
    edits.push({
      page: parseInt(span.dataset.page),
      text: span.textContent.replaceAll(q, r),
      x: rect.left,
      y: rect.top,
      size: parseFloat(span.style.fontSize)
    });
    span.textContent = span.textContent.replaceAll(q, r);
    span.classList.remove("highlight");
  });

  matches = [];
};

function clearHighlights() {
  document.querySelectorAll(".highlight").forEach(e => e.classList.remove("highlight"));
}

/* EXPORT */
download.onclick = async () => {
  const pdf = await PDFLib.PDFDocument.load(await file.files[0].arrayBuffer());
  const pagesArr = pdf.getPages();

  edits.forEach(e => {
    const p = pagesArr[e.page - 1];
    const h = p.getHeight();

    p.drawRectangle({
      x: e.x / 1.5,
      y: h - e.y / 1.5,
      width: 400,
      height: e.size + 6,
      color: PDFLib.rgb(1,1,1)
    });

    p.drawText(e.text, {
      x: e.x / 1.5,
      y: h - e.y / 1.5,
      size: e.size
    });
  });

  const out = await pdf.save();
  const a = document.createElement("a");
  a.href = URL.createObjectURL(new Blob([out]));
  a.download = "edited.pdf";
  a.click();
};
</script>

</body>
</html>
